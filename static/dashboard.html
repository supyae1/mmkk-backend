<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revenue Engine Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-6">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-semibold">Revenue command centre</h1>
        <p class="text-slate-400">Anon visits + signals + tracking verification.</p>
      </div>

      <div class="flex gap-2">
        <button id="btnTest" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">Send test event</button>
        <button id="btnRefresh" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Refresh data</button>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="rounded-xl bg-slate-900 p-4">
        <div class="text-slate-400 text-sm">Anonymous visits</div>
        <div id="anonCount" class="text-3xl font-bold mt-2">0</div>
      </div>
      <div class="rounded-xl bg-slate-900 p-4">
        <div class="text-slate-400 text-sm">Events (last 200)</div>
        <div id="eventCount" class="text-3xl font-bold mt-2">0</div>
      </div>
      <div class="rounded-xl bg-slate-900 p-4">
        <div class="text-slate-400 text-sm">API base</div>
        <div id="apiBase" class="text-sm mt-2 break-all text-slate-200"></div>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="rounded-xl bg-slate-900 p-4">
        <h2 class="font-semibold">Anonymous visits</h2>
        <div id="anonList" class="mt-3 space-y-2 text-sm text-slate-200"></div>
      </div>

      <div class="rounded-xl bg-slate-900 p-4">
        <h2 class="font-semibold">Activity feed</h2>
        <div id="feedList" class="mt-3 space-y-2 text-sm text-slate-200"></div>
      </div>
    </div>

    <div class="mt-6 rounded-xl bg-slate-900 p-4">
      <h2 class="font-semibold">Website pixel snippet (install on client website)</h2>
      <pre class="mt-2 p-3 rounded-lg bg-slate-950 text-slate-200 overflow-auto text-xs"><code id="pixelSnippet"></code></pre>
    </div>
  </div>

<script>
  const API_BASE = window.location.origin;
  const API_KEY  = "supersecret123";

  document.getElementById("apiBase").innerText = API_BASE;

  // IMPORTANT: escape closing script tag inside JS string
  document.getElementById("pixelSnippet").innerText =
    `<script src="${API_BASE}/pixel.js" data-api-key="${API_KEY}"><\\/script>`;

  async function apiGet(path) {
    const res = await fetch(API_BASE + path, { headers: { "X-API-Key": API_KEY } });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function apiPost(path, body) {
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-API-Key": API_KEY },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function renderAnon(list) {
    const el = document.getElementById("anonList");
    el.innerHTML = "";
    list.slice(0, 30).forEach(v => {
      const row = document.createElement("div");
      row.className = "p-2 rounded-lg bg-slate-950";
      row.innerHTML = `
        <div><b>${v.anonymous_id}</b> — ${v.ip || "?"}</div>
        <div class="text-slate-400">${(v.url || "").slice(0,120)}</div>
        <div class="text-slate-500">${v.created_at || ""}</div>
      `;
      el.appendChild(row);
    });
  }

  function renderFeed(items) {
    const el = document.getElementById("feedList");
    el.innerHTML = "";
    items.slice(0, 40).forEach(e => {
      const row = document.createElement("div");
      row.className = "p-2 rounded-lg bg-slate-950";
      row.innerHTML = `
        <div><b>${e.event_type}</b> — ${e.channel || "?"}</div>
        <div class="text-slate-400">${(e.url || "").slice(0,120)}</div>
        <div class="text-slate-500">${e.created_at || ""}</div>
      `;
      el.appendChild(row);
    });
  }

  async function refresh() {
    const visits = await apiGet("/insights/anon-visits");
    const feed = await apiGet("/insights/activity-feed");

    document.getElementById("anonCount").innerText = visits.length;
    document.getElementById("eventCount").innerText = (feed.items || []).length;

    renderAnon(visits);
    renderFeed(feed.items || []);
  }

  document.getElementById("btnRefresh").onclick = refresh;

  document.getElementById("btnTest").onclick = async () => {
    const anon = "anon_demo_" + Math.random().toString(16).slice(2, 8);
    await apiPost("/public/track", {
      event_type: "page_view",
      anonymous_id: anon,
      url: window.location.href,
      path: window.location.pathname,
      referrer: document.referrer || null,
      utm: { source: "demo", medium: "cpc", campaign: "pitch" },
      metadata: { value: 10, currency: "USD" }
    });
    await refresh();
    alert("Test event sent. Refreshing dashboard.");
  };

  refresh().catch(err => console.error(err));
</script>

</body>
</html>
